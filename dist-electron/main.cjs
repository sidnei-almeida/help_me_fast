"use strict";var b=Object.create;var I=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var x=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var D=(e,a,t,r)=>{if(a&&typeof a=="object"||typeof a=="function")for(let i of _(a))!F.call(e,i)&&i!==t&&I(e,i,{get:()=>a[i],enumerable:!(r=S(a,i))||r.enumerable});return e};var N=(e,a,t)=>(t=e!=null?b(x(e)):{},D(a||!e||!e.__esModule?I(t,"default",{value:e,enumerable:!0}):t,e));var s=require("electron"),c=N(require("path"),1),n=require("fs"),m=require("fs"),y=!s.app.isPackaged;function o(...e){y&&console.log(...e)}function g(...e){console.error(...e)}process.platform==="linux"&&(s.app.commandLine.appendSwitch("ozone-platform-hint","auto"),s.app.commandLine.appendSwitch("enable-wayland-ime"),process.env.ELECTRON_DISABLE_GPU==="1"&&s.app.disableHardwareAcceleration());function C(){let e=c.default.join(__dirname,"preload.cjs");if(o("[Main] __dirname:",__dirname),o("[Main] preloadPath:",e),o("[Main] preload exists:",(0,m.existsSync)(e)),!(0,m.existsSync)(e)){g("[Main] FATAL: preload.cjs not found at",e),s.app.quit();return}let a=!!(process.env.WAYLAND_DISPLAY||process.env.XDG_SESSION_TYPE==="wayland");o("[Main] Display server:",a?"Wayland":"X11");let t=new s.BrowserWindow({width:1200,height:800,minWidth:800,minHeight:600,frame:!1,webPreferences:{preload:e,nodeIntegration:!1,contextIsolation:!0,sandbox:!1,enableRemoteModule:!1},autoHideMenuBar:!0,backgroundColor:"#F2F2F7",show:!1});t.once("ready-to-show",()=>{t.show(),y&&t.webContents.openDevTools({mode:"detach"})}),t.webContents.on("preload-error",(r,i,l)=>{g("[Main] Preload error:",l)}),s.ipcMain.on("window:minimize",()=>{t.minimize()}),s.ipcMain.on("window:maximize",()=>{t.isMaximized()?t.unmaximize():t.maximize()}),s.ipcMain.on("window:close",()=>{t.close()}),s.ipcMain.handle("window:is-maximized",()=>t.isMaximized()),t.on("maximize",()=>{t.webContents.send("window:maximized-changed",!0)}),t.on("unmaximize",()=>{t.webContents.send("window:maximized-changed",!1)}),y?t.loadURL("http://localhost:5173"):t.loadFile(c.default.join(__dirname,"../dist/index.html"))}function O(e){let a=c.default.extname(e).slice(1).toLowerCase();return a==="jpg"||a==="jpeg"?"image/jpeg":a==="png"?"image/png":a==="webp"?"image/webp":a==="gif"?"image/gif":"image/png"}async function p(e){try{await n.promises.access(e);let a=await n.promises.readFile(e);return`data:${O(e)};base64,${a.toString("base64")}`}catch{return null}}function j(){return c.default.join(s.app.getPath("userData"),"settings.json")}async function E(){try{let e=await n.promises.readFile(j(),"utf-8");return JSON.parse(e)}catch{return{}}}async function M(e){let t={...await E(),...e};await n.promises.writeFile(j(),JSON.stringify(t,null,2),"utf-8")}function z(){s.ipcMain.handle("settings:get-last-vault",async()=>{o("[IPC] settings:get-last-vault called");try{let e=await E();if(!e.lastVaultPath)return o("[IPC] No last vault saved"),null;try{if(!(await n.promises.stat(e.lastVaultPath)).isDirectory())return o("[IPC] Last vault path is not a directory:",e.lastVaultPath),null}catch{return o("[IPC] Last vault path no longer exists:",e.lastVaultPath),null}let a=c.default.join(e.lastVaultPath,"config.json");try{await n.promises.access(a)}catch{return o("[IPC] Last vault path has no config.json:",e.lastVaultPath),null}return o("[IPC] Last vault found and valid:",e.lastVaultPath),e.lastVaultPath}catch(e){return g("[IPC] settings:get-last-vault error:",e),null}}),s.ipcMain.handle("settings:set-last-vault",async(e,a)=>{o("[IPC] settings:set-last-vault called:",a);try{return await M({lastVaultPath:a}),{success:!0}}catch(t){return g("[IPC] settings:set-last-vault error:",t),{success:!1,error:t.message}}}),s.ipcMain.handle("dialog:openDirectory",async()=>{let e=await s.dialog.showOpenDialog({properties:["openDirectory","createDirectory"],title:"Select Vault Folder"});return e.canceled||e.filePaths.length===0?null:e.filePaths[0]}),s.ipcMain.handle("dialog:select-image",async()=>{o("[IPC] dialog:select-image called");let e=await s.dialog.showOpenDialog({properties:["openFile"],title:"Select Profile Photo",filters:[{name:"Images",extensions:["jpg","jpeg","png","gif","webp"]}]});return e.canceled||e.filePaths.length===0?null:(o("[IPC] Image selected:",e.filePaths[0]),await p(e.filePaths[0]))}),s.ipcMain.handle("vault:save-avatar",async(e,a,t)=>{o("[IPC] vault:save-avatar called, vaultPath:",a);try{let r=t.match(/^data:image\/\w+;base64,(.+)$/);if(!r)return g("[IPC] vault:save-avatar - Invalid data URI format"),{success:!1,error:"Invalid image data format"};let i=Buffer.from(r[1],"base64"),l=c.default.join(a,"avatar.png");return await n.promises.mkdir(a,{recursive:!0}),await n.promises.writeFile(l,i),o("[IPC] Avatar saved to:",l,"- size:",i.length,"bytes"),{success:!0,avatarPath:"avatar.png"}}catch(r){return g("[IPC] vault:save-avatar error:",r),{success:!1,error:r.message}}}),s.ipcMain.handle("user:load-avatar",async(e,a)=>{o("[IPC] user:load-avatar called, vaultPath:",a);try{let t=c.default.join(a,"profile.json"),r=null;try{let u=await n.promises.readFile(t,"utf-8");r=JSON.parse(u).avatar||null}catch{return o("[IPC] user:load-avatar - no profile.json found"),null}if(!r)return o("[IPC] user:load-avatar - no avatar path in profile"),null;let i=c.default.isAbsolute(r)?r:c.default.join(a,r),l=await p(i);return o("[IPC] user:load-avatar - result:",l?`OK (${l.length} chars)`:"null"),l}catch(t){return g("[IPC] user:load-avatar error:",t),null}}),s.ipcMain.handle("vault:read-file",async(e,a)=>{try{let t=await n.promises.readFile(a,"utf-8");return{success:!0,data:JSON.parse(t)}}catch(t){return{success:!1,error:t.message}}}),s.ipcMain.handle("vault:write-file",async(e,a,t)=>{try{let r=c.default.dirname(a);return await n.promises.mkdir(r,{recursive:!0}),await n.promises.writeFile(a,JSON.stringify(t,null,2),"utf-8"),{success:!0}}catch(r){return{success:!1,error:r.message}}}),s.ipcMain.handle("vault:file-exists",async(e,a)=>{try{return await n.promises.access(a),{exists:!0}}catch{return{exists:!1}}}),s.ipcMain.handle("vault:init-vault",async(e,a)=>{o("[IPC] vault:init-vault called, path:",a);try{let t=c.default.join(a,"config.json"),r=c.default.join(a,"profile.json"),i=c.default.join(a,"history.json"),l={vaultPath:a,theme:"dark",notifications:!0,dangerZones:[{start:18,end:20}],weightUnit:"kg"},u={name:"",weight:0,height:0,tmb:0,age:0,gender:"male",activityLevel:"moderate"},d={fasts:[]};await n.promises.mkdir(a,{recursive:!0});let h=await n.promises.access(t).then(()=>!0).catch(()=>!1),f=await n.promises.access(r).then(()=>!0).catch(()=>!1),w=await n.promises.access(i).then(()=>!0).catch(()=>!1);return h||await n.promises.writeFile(t,JSON.stringify(l,null,2),"utf-8"),f||await n.promises.writeFile(r,JSON.stringify(u,null,2),"utf-8"),w||await n.promises.writeFile(i,JSON.stringify(d,null,2),"utf-8"),o("[IPC] vault:init-vault done"),{success:!0}}catch(t){return g("[IPC] vault:init-vault error:",t),{success:!1,error:t.message}}}),s.ipcMain.handle("history:add-entry",async(e,a,t)=>{o("[IPC] history:add-entry called");try{let r=c.default.join(a,"history.json"),i={fasts:[],progressEntries:[]};try{let h=await n.promises.readFile(r,"utf-8");i=JSON.parse(h),i.progressEntries||(i.progressEntries=[])}catch{}let l=`entry_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,u;if(t.photoBase64){let h=c.default.join(a,"photos");await n.promises.mkdir(h,{recursive:!0});let f=t.photoBase64.match(/^data:image\/(\w+);base64,(.+)$/);if(f){let w=f[1]==="jpeg"?"jpg":f[1],P=`photo_${Date.now()}.${w}`,v=c.default.join(h,P);await n.promises.writeFile(v,Buffer.from(f[2],"base64")),u=`photos/${P}`,o("[IPC] Photo saved:",v)}}let d={id:l,date:t.date,...t.weight!==void 0&&{weight:t.weight},...u&&{photoPath:u},...t.notes&&{notes:t.notes}};return i.progressEntries.push(d),i.progressEntries.sort((h,f)=>new Date(f.date).getTime()-new Date(h.date).getTime()),await n.promises.writeFile(r,JSON.stringify(i,null,2),"utf-8"),o("[IPC] Entry added:",d.id),{success:!0,entry:d}}catch(r){return g("[IPC] history:add-entry error:",r),{success:!1,error:r.message}}}),s.ipcMain.handle("history:get-all",async(e,a)=>{o("[IPC] history:get-all called");try{let t=c.default.join(a,"history.json"),r={fasts:[],progressEntries:[]};try{let l=await n.promises.readFile(t,"utf-8");r=JSON.parse(l),r.progressEntries||(r.progressEntries=[])}catch{return{success:!0,entries:[]}}let i=await Promise.all(r.progressEntries.map(async l=>{let u=null;if(l.photoPath){let d=c.default.join(a,l.photoPath);u=await p(d)}return{...l,photoBase64:u}}));return i.sort((l,u)=>new Date(u.date).getTime()-new Date(l.date).getTime()),o("[IPC] Returning",i.length,"progress entries"),{success:!0,entries:i}}catch(t){return g("[IPC] history:get-all error:",t),{success:!1,error:t.message}}}),s.ipcMain.handle("history:delete-entry",async(e,a,t)=>{o("[IPC] history:delete-entry called, id:",t);try{let r=c.default.join(a,"history.json"),i=await n.promises.readFile(r,"utf-8"),l=JSON.parse(i);if(!l.progressEntries)return{success:!0};let u=l.progressEntries.find(d=>d.id===t);if(u?.photoPath){let d=c.default.join(a,u.photoPath);try{await n.promises.unlink(d)}catch{}}return l.progressEntries=l.progressEntries.filter(d=>d.id!==t),await n.promises.writeFile(r,JSON.stringify(l,null,2),"utf-8"),{success:!0}}catch(r){return g("[IPC] history:delete-entry error:",r),{success:!1,error:r.message}}})}z();s.app.whenReady().then(()=>{C(),s.app.on("activate",()=>{s.BrowserWindow.getAllWindows().length===0&&C()})});s.app.on("window-all-closed",()=>{process.platform!=="darwin"&&s.app.quit()});
